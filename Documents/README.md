# keiba_systems

┌─────────────────────────────────────────┐

│          API Gateway / Load Balancer    │

└────┬────┬────┬─────┬──────┬───────┬────┘

     │    │    │     │      │       │

  ┌──▼──┐ │ ┌──▼───┐ │  ┌───▼────┐ │

  │馬券  │ │ │馬券  │ │  │オッズ  │ │

  │購入  │ │ │参照  │ │  │参照   │ │

  │API  │ │ │API  │ │  │API    │ │

  └──┬──┘ │ └──┬──┘ │  └───┬───┘ │

     │    │    │    │      │      │

     │  ┌─▼────▼────▼──────▼──────▼──┐

     │  │   レース管理サービス          │

     │  └──────────────────────────────┘

     │                              │

  ┌──▼────┐                    ┌───▼──────┐

  │Message│                    │払い戻し   │

  │Queue  │                    │計算API   │

  │(Kafka)│                    └───┬──────┘

  └──┬────┘                        │

     │                             │

  ┌──▼──────────────┐          ┌───▼──────┐

  │DB書き込みAPI     │──────────│払い戻し  │

  │(Consumer)       │          │実行API   │

  └──┬──────────────┘          └───┬──────┘

     │                             │

  ┌──▼────────────────┐            │

  │   PostgreSQL      │ ← Source of Truth

  │  (馬券・払い戻し)  │◄───────────┘

  └──┬────────────────┘

     │ 非同期同期

     │ (CDC or Batch)

  ┌──▼────────────────┐

  │      Redis        │  ← キャッシュ層

  │ (オッズ・馬券参照) │

  └───────────────────┘

```



### 2.2 データフロー（改訂版）



#### 馬券購入フロー（MQ統合版）

```

1. ユーザー → 馬券購入API

2. レース状態確認（Redis: OPEN状態のみ受付）

3. 購入リクエストをMessage Queue（Kafka）に送信

4. メッセージID（購入受付番号）をユーザーへ即座に返却

   ※この時点でDBにはまだ書き込まれていない



--- 非同期処理 ---



5. DB書き込みAPI（Consumer）がMQからメッセージを取得

6. PostgreSQLへ馬券データ書き込み

7. 書き込み成功後、Redisのオッズを更新

8. 書き込み結果をステータス管理用Redisに保存

   Key: purchase:{message_id}:status

   Value: "COMPLETED" or "FAILED"

```



#### 購入確認フロー（新規）

```

1. ユーザー → 馬券参照API

2. purchase:{message_id}:status をRedisで確認

3. COMPLETEDなら馬券詳細を返却、PENDINGなら処理中を通知

```



#### オッズ参照フロー（変更なし）

```

1. ユーザー → オッズ参照API

2. Redisから参考オッズ取得

3. ユーザーへ返却

```



#### 締切・確定オッズ計算フロー（変更なし）

```

1. 締切時刻到達

2. レース状態をCLOSEDに変更

3. PostgreSQLから全購入データ集計

4. 確定オッズ計算

5. PostgreSQLへ確定オッズ保存

6. Redisへ確定オッズ更新

```



#### 払い戻し計算フロー（新規）

```

1. レース結果確定

2. 払い戻し計算API起動（バッチまたはイベント駆動）

3. PostgreSQLから的中馬券を抽出

4. 確定オッズを使用して払い戻し額計算

5. 払い戻し対象データをPostgreSQLに保存

```



#### 払い戻し実行フロー（新規）

```

1. ユーザー → 払い戻し実行API

2. PostgreSQLで払い戻しステータス確認（冪等性）

3. 払い戻し額をユーザー残高に反映

4. 払い戻しステータスを「PAID」に更新

```



## Kafkaメッセージ設計



### トピック構成

```

topic: betting.ticket.purchase

partition: race_id % partition_count （レース単位で順序保証）



メッセージフォーマット（JSON）:

{

  "message_id": "uuid-xxx",

  "user_id": 12345,

  "race_id": 100,

  "horse_number": 5,

  "bet_type": "WIN",

  "amount": 1000,

  "timestamp": "2025-10-26T10:30:00Z"

}
